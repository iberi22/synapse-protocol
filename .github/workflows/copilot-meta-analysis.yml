name: "ðŸ§  Copilot Meta-Analysis"

# Triggers when AI bots complete their reviews
# Assigns Copilot for final meta-analysis using Claude Sonnet 4.5
# NOTE: Schedule reduced to hourly to comply with GitHub Actions usage policies

env:
  PROTOCOL_VERSION: "1.3.0"

on:
  # React to PR comments (bot reviews)
  issue_comment:
    types: [created]

  # Scheduled check for pending analyses (hourly to avoid rate limits)
  # Using minute 17 to avoid hourly peak congestion
  schedule:
    - cron: "17 * * * *" # Every hour at minute 17

  # Manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to analyze"
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Detect Bot Reviews Completion
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-completion:
    name: "ðŸ” Detect Bot Completion"
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' &&
       contains(fromJson('["coderabbitai", "gemini-code-assist", "github-actions"]'), github.event.comment.user.login))
    outputs:
      ready_prs: ${{ steps.check.outputs.ready_prs }}
      has_ready: ${{ steps.check.outputs.has_ready }}

    steps:
      - name: Check for Ready PRs
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If manual trigger
          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "ready_prs=[{\"number\":${{ inputs.pr_number }}}]" >> $GITHUB_OUTPUT
            echo "has_ready=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find PRs with validation label awaiting Copilot
          echo "Fetching PRs..."
          VALIDATION_PRS=$(gh pr list \
            --label "validation,ai-review-requested" \
            --state open \
            --json number,comments,createdAt \
            --jq '.' || echo "[]")

          echo "Found PRs: $VALIDATION_PRS"

          # Use temp file to avoid subshell issue with while loop
          READY_PRS="[]"
          TMP_FILE=$(mktemp)
          echo "[]" > "$TMP_FILE"

          # Process each PR
          for pr in $(echo "$VALIDATION_PRS" | jq -r '.[].number'); do
            # Check if both bots have commented
            COMMENTS=$(gh pr view "$pr" --json comments --jq '.comments[].author.login' 2>/dev/null || echo "")

            HAS_CODERABBIT=$(echo "$COMMENTS" | grep -c "coderabbitai" || echo "0")
            HAS_GEMINI=$(echo "$COMMENTS" | grep -c "gemini-code-assist" || echo "0")

            # Check if already processed by Copilot
            HAS_COPILOT_META=$(gh pr view "$pr" --json comments \
              --jq '.comments[] | select(.body | contains("Meta-Analysis Complete"))' 2>/dev/null | wc -l || echo "0")

            if [ "$HAS_CODERABBIT" -gt 0 ] && [ "$HAS_GEMINI" -gt 0 ] && [ "$HAS_COPILOT_META" -eq 0 ]; then
              echo "âœ… PR #$pr ready for Copilot meta-analysis"
              jq ". + [{\"number\": $pr}]" "$TMP_FILE" > "${TMP_FILE}.new" && mv "${TMP_FILE}.new" "$TMP_FILE"
            fi
          done

          READY_PRS=$(cat "$TMP_FILE")
          rm -f "$TMP_FILE"

          if [ "$(echo "$READY_PRS" | jq 'length')" -gt 0 ]; then
            echo "ready_prs=$READY_PRS" >> $GITHUB_OUTPUT
            echo "has_ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready_prs=[]" >> $GITHUB_OUTPUT
            echo "has_ready=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Collect AI Reviews
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  collect-reviews:
    name: "ðŸ“š Collect AI Reviews"
    runs-on: ubuntu-latest
    needs: detect-completion
    if: needs.detect-completion.outputs.has_ready == 'true'
    outputs:
      analysis_data: ${{ steps.collect.outputs.data }}

    steps:
      - name: Collect All Bot Comments
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          READY_PRS='${{ needs.detect-completion.outputs.ready_prs }}'

          ALL_DATA="[]"

          echo "$READY_PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')

            echo "ðŸ“š Collecting reviews for PR #$PR_NUM..."

            # Get all comments
            COMMENTS=$(gh pr view "$PR_NUM" --json comments --jq '.comments')

            # Extract CodeRabbit reviews
            CODERABBIT_REVIEWS=$(echo "$COMMENTS" | jq '[.[] | select(.author.login == "coderabbitai") | .body]')

            # Extract Gemini reviews
            GEMINI_REVIEWS=$(echo "$COMMENTS" | jq '[.[] | select(.author.login == "gemini-code-assist") | .body]')

            # Get PR details
            PR_DETAILS=$(gh pr view "$PR_NUM" --json title,body,files)

            # Combine data
            PR_DATA=$(jq -n \
              --argjson pr_num "$PR_NUM" \
              --argjson coderabbit "$CODERABBIT_REVIEWS" \
              --argjson gemini "$GEMINI_REVIEWS" \
              --argjson details "$PR_DETAILS" \
              '{
                pr_number: $pr_num,
                coderabbit_reviews: $coderabbit,
                gemini_reviews: $gemini,
                pr_details: $details
              }')

            ALL_DATA=$(echo "$ALL_DATA" | jq ". + [$PR_DATA]")
          done

          # Save to file for next job
          echo "$ALL_DATA" > /tmp/analysis_data.json
          echo "data=$(cat /tmp/analysis_data.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: Upload Analysis Data
        uses: actions/upload-artifact@v5
        with:
          name: ai-reviews-data
          path: /tmp/analysis_data.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Copilot Meta-Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  copilot-analysis:
    name: "ðŸ§  Copilot Meta-Analysis"
    runs-on: ubuntu-latest
    needs: [detect-completion, collect-reviews]
    if: needs.detect-completion.outputs.has_ready == 'true'
    strategy:
      matrix:
        pr: ${{ fromJson(needs.detect-completion.outputs.ready_prs) }}
      max-parallel: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download Analysis Data
        uses: actions/download-artifact@v6
        with:
          name: ai-reviews-data
          path: ./data

      - name: Generate Meta-Analysis Prompt
        id: prompt
        run: |
          PR_NUM="${{ matrix.pr.number }}"

          # Extract data for this PR
          PR_DATA=$(cat ./data/analysis_data.json | jq ".[] | select(.pr_number == $PR_NUM)")

          # Build comprehensive prompt
          cat > meta_prompt.md << 'PROMPT_EOF'
          # Copilot Meta-Analysis Task

          You are performing a meta-analysis of AI code reviews. Your task is to:

          1. **Synthesize** feedback from CodeRabbit and Gemini
          2. **Validate** their recommendations
          3. **Identify** conflicts or gaps
          4. **Prioritize** actions by impact
          5. **Generate** implementation plan

          ## AI Reviews to Analyze

          ### CodeRabbit Feedback
          PROMPT_EOF

          echo "$PR_DATA" | jq -r '.coderabbit_reviews[]' >> meta_prompt.md

          cat >> meta_prompt.md << 'PROMPT_EOF'

          ### Gemini Code Assist Feedback
          PROMPT_EOF

          echo "$PR_DATA" | jq -r '.gemini_reviews[]' >> meta_prompt.md

          cat >> meta_prompt.md << 'PROMPT_EOF'

          ## Your Analysis Should Include

          1. **Summary of AI Feedback**
             - Key points from CodeRabbit
             - Key points from Gemini
             - Areas of agreement
             - Areas of disagreement

          2. **Validated Recommendations**
             - Which suggestions should be implemented?
             - Which need more investigation?
             - Which should be rejected and why?

          3. **Priority Matrix**
             | Priority | Issue | Impact | Effort |
             |----------|-------|--------|--------|
             | ... | ... | ... | ... |

          4. **Implementation Roadmap**
             - Immediate fixes (this PR)
             - Follow-up issues to create
             - Long-term improvements

          5. **Metrics Improvement Estimate**
             - Performance impact
             - Security improvements
             - Reliability gains

          Please provide your analysis in a structured format.
          PROMPT_EOF

          echo "prompt_file=meta_prompt.md" >> $GITHUB_OUTPUT

      - name: Create Copilot Analysis Issue
        id: copilot-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ matrix.pr.number }}"
          PROMPT_CONTENT=$(cat meta_prompt.md)

          ISSUE_BODY="## ðŸ§  Meta-Analysis Request for PR #$PR_NUM

          This issue requests Copilot to perform meta-analysis of AI code reviews.

          ---

          $PROMPT_CONTENT

          ---

          ## Instructions for Copilot

          1. Analyze the AI reviews above
          2. Generate a comprehensive meta-analysis
          3. Post your findings as a comment on PR #$PR_NUM
          4. If fixes are needed, create follow-up implementation PRs

          ### After Analysis

          Comment on PR #$PR_NUM with:
          \`\`\`
          ## ðŸ§  Copilot Meta-Analysis Complete

          [Your analysis here]
          \`\`\`

          ---
          *Git-Core Protocol - Multi-Agent Validation*"

          ISSUE_URL=$(gh issue create \
            --title "ðŸ§  Copilot: Meta-analyze PR #$PR_NUM" \
            --body "$ISSUE_BODY" \
            --label "copilot,meta-analysis,validation")

          ISSUE_NUM=$(echo "$ISSUE_URL" | grep -oP '\d+$')
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Assign Copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.copilot-issue.outputs.issue_number }}"

          # Add copilot label to trigger assignment
          gh issue edit "$ISSUE_NUM" --add-label "copilot"

          # Add trigger comment
          gh issue comment "$ISSUE_NUM" --body "@copilot Please perform the meta-analysis described above.

          Use Claude Sonnet 4.5 for comprehensive analysis.

          After analysis, post your findings to PR #${{ matrix.pr.number }}."

      - name: Update PR Status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ matrix.pr.number }}"

          gh pr comment "$PR_NUM" --body "## ðŸ§  Copilot Meta-Analysis Initiated

          **Status:** Copilot has been assigned for meta-analysis

          ### What's Happening

          1. âœ… CodeRabbit review collected
          2. âœ… Gemini Code Assist review collected
          3. ðŸ”„ Copilot analyzing all feedback
          4. â³ Implementation plan pending

          ### Tracking

          - **Meta-Analysis Issue:** #${{ steps.copilot-issue.outputs.issue_number }}

          ---

          Copilot will post the final analysis here when complete.

          *Git-Core Protocol - Continuous Improvement*"

          # Update labels
          gh pr edit "$PR_NUM" \
            --remove-label "ai-review-requested" \
            --add-label "copilot-analyzing"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“Š Summary"
    runs-on: ubuntu-latest
    needs: [detect-completion, copilot-analysis]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§  Copilot Meta-Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PRs Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.detect-completion.outputs.ready_prs }}' | jq -r '.[] | "- PR #\(.number)"' >> $GITHUB_STEP_SUMMARY || echo "- None" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- Ready PRs found: ${{ needs.detect-completion.outputs.has_ready }}" >> $GITHUB_STEP_SUMMARY
          echo "- Meta-analysis: ${{ needs.copilot-analysis.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
