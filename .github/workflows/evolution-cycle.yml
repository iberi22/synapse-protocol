name: Weekly Evolution Cycle

on:
  schedule:
    # Runs every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      week_offset:
        description: 'Weeks to look back (0=current, 1=last week)'
        required: false
        default: '1'
      create_issue:
        description: 'Create GitHub issue with report'
        required: false
        default: 'true'

permissions:
  issues: write
  contents: read

jobs:
  collect-metrics:
    name: üìä Collect Metrics
    runs-on: ubuntu-latest
    outputs:
      metrics_json: ${{ steps.metrics.outputs.json }}
    steps:
      - uses: actions/checkout@v6

      - name: Calculate date range
        id: dates
        run: |
          WEEK_OFFSET=${{ github.event.inputs.week_offset || '1' }}
          END_DATE=$(date -d "-$((WEEK_OFFSET * 7)) days" +%Y-%m-%d)
          START_DATE=$(date -d "$END_DATE -7 days" +%Y-%m-%d)
          WEEK_NUM=$(date -d "$END_DATE" +%V)
          YEAR=$(date -d "$END_DATE" +%Y)

          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          echo "week_num=$WEEK_NUM" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT

      - name: Collect GitHub metrics
        id: metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          START_DATE="${{ steps.dates.outputs.start_date }}"
          END_DATE="${{ steps.dates.outputs.end_date }}"

          # Issues opened
          ISSUES_OPENED=$(gh issue list --state all --json createdAt \
            --jq "[.[] | select(.createdAt >= \"${START_DATE}\" and .createdAt <= \"${END_DATE}\")] | length")

          # Issues closed
          ISSUES_CLOSED=$(gh issue list --state closed --json closedAt \
            --jq "[.[] | select(.closedAt >= \"${START_DATE}\" and .closedAt <= \"${END_DATE}\")] | length")

          # PRs merged
          PRS_MERGED=$(gh pr list --state merged --json mergedAt \
            --jq "[.[] | select(.mergedAt >= \"${START_DATE}\" and .mergedAt <= \"${END_DATE}\")] | length")

          # Friction issues
          FRICTION=$(gh issue list --label "friction" --state all --json number | jq 'length')

          # Evolution proposals
          EVOLUTION=$(gh issue list --label "evolution" --state all --json number | jq 'length')

          # Agent-state usage (check last 20 issues)
          AGENT_STATE_COUNT=0
          TOTAL_CHECKED=0
          for ISSUE_NUM in $(gh issue list --limit 20 --json number --jq '.[].number'); do
            TOTAL_CHECKED=$((TOTAL_CHECKED + 1))
            COMMENTS=$(gh issue view $ISSUE_NUM --json body,comments --jq '.body, .comments[].body')
            if echo "$COMMENTS" | grep -q "<agent-state>"; then
              AGENT_STATE_COUNT=$((AGENT_STATE_COUNT + 1))
            fi
          done

          if [ $TOTAL_CHECKED -gt 0 ]; then
            AGENT_STATE_PCT=$((AGENT_STATE_COUNT * 100 / TOTAL_CHECKED))
          else
            AGENT_STATE_PCT=0
          fi

          # Build JSON output
          cat << EOF > metrics.json
          {
            "week": ${{ steps.dates.outputs.week_num }},
            "year": ${{ steps.dates.outputs.year }},
            "order1": {
              "issues_opened": $ISSUES_OPENED,
              "issues_closed": $ISSUES_CLOSED,
              "prs_merged": $PRS_MERGED
            },
            "order2": {
              "agent_state_usage_pct": $AGENT_STATE_PCT
            },
            "order3": {
              "friction_reports": $FRICTION,
              "improvement_proposals": $EVOLUTION
            }
          }
          EOF

          echo "json=$(cat metrics.json | jq -c)" >> $GITHUB_OUTPUT
          cat metrics.json

  analyze-patterns:
    name: üîç Analyze Patterns
    runs-on: ubuntu-latest
    needs: collect-metrics
    outputs:
      patterns: ${{ steps.analyze.outputs.patterns }}
    steps:
      - name: Analyze metrics
        id: analyze
        run: |
          METRICS='${{ needs.collect-metrics.outputs.metrics_json }}'

          PATTERNS="[]"

          # Throughput check
          OPENED=$(echo "$METRICS" | jq '.order1.issues_opened')
          CLOSED=$(echo "$METRICS" | jq '.order1.issues_closed')

          if [ "$CLOSED" -gt "$OPENED" ]; then
            PATTERNS=$(echo "$PATTERNS" | jq '. + [{"type": "positive", "desc": "Throughput healthy: closing > opening"}]')
          elif [ "$OPENED" -gt $((CLOSED * 2)) ]; then
            PATTERNS=$(echo "$PATTERNS" | jq '. + [{"type": "warning", "desc": "Backlog growing rapidly"}]')
          fi

          # Agent-state adoption
          ADOPTION=$(echo "$METRICS" | jq '.order2.agent_state_usage_pct')
          if [ "$ADOPTION" -lt 50 ]; then
            PATTERNS=$(echo "$PATTERNS" | jq '. + [{"type": "attention", "desc": "Low agent-state adoption ('$ADOPTION'%). Reinforce documentation."}]')
          elif [ "$ADOPTION" -ge 80 ]; then
            PATTERNS=$(echo "$PATTERNS" | jq '. + [{"type": "positive", "desc": "Excellent agent-state adoption ('$ADOPTION'%)"}]')
          fi

          echo "patterns=$(echo "$PATTERNS" | jq -c)" >> $GITHUB_OUTPUT

  generate-report:
    name: üìù Generate Report
    runs-on: ubuntu-latest
    needs: [collect-metrics, analyze-patterns]
    if: ${{ github.event.inputs.create_issue != 'false' }}
    steps:
      - name: Create Evolution Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          METRICS='${{ needs.collect-metrics.outputs.metrics_json }}'
          PATTERNS='${{ needs.analyze-patterns.outputs.patterns }}'

          WEEK=$(echo "$METRICS" | jq -r '.week')
          YEAR=$(echo "$METRICS" | jq -r '.year')

          # Format patterns
          PATTERNS_MD=""
          for row in $(echo "$PATTERNS" | jq -r '.[] | @base64'); do
            _jq() { echo "$row" | base64 --decode | jq -r "${1}"; }
            TYPE=$(_jq '.type')
            DESC=$(_jq '.desc')
            case $TYPE in
              positive) ICON="‚úÖ" ;;
              warning) ICON="‚ö†Ô∏è" ;;
              attention) ICON="üî∂" ;;
              *) ICON="‚û°Ô∏è" ;;
            esac
            PATTERNS_MD="$PATTERNS_MD\n- $ICON **$TYPE:** $DESC"
          done

          BODY=$(cat << EOF
          ## üìä Evolution Report - Week $WEEK ($YEAR)

          *Auto-generated by Evolution Cycle workflow*

          ### Order 1: Operational Metrics

          | Metric | Value | Trend |
          |--------|-------|-------|
          | Issues Opened | $(echo "$METRICS" | jq '.order1.issues_opened') | - |
          | Issues Closed | $(echo "$METRICS" | jq '.order1.issues_closed') | - |
          | PRs Merged | $(echo "$METRICS" | jq '.order1.prs_merged') | - |

          ### Order 2: Quality Metrics

          | Metric | Value | Target |
          |--------|-------|--------|
          | Agent-State Usage | $(echo "$METRICS" | jq '.order2.agent_state_usage_pct')% | > 80% |

          ### Order 3: Evolution Metrics

          | Metric | Value |
          |--------|-------|
          | Friction Reports | $(echo "$METRICS" | jq '.order3.friction_reports') |
          | Improvement Proposals | $(echo "$METRICS" | jq '.order3.improvement_proposals') |

          ### Patterns Detected

          $(echo -e "$PATTERNS_MD")

          ---

          üìö **Protocol:** [EVOLUTION_PROTOCOL.md](docs/agent-docs/EVOLUTION_PROTOCOL.md)
          EOF
          )

          gh issue create \
            --title "[Evolution] Weekly Report - Week $WEEK ($YEAR)" \
            --body "$BODY" \
            --label "evolution,weekly-report"
